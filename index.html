<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>A to Z – Daily Accounts (Realtime)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{--pri:#0ea5e9;--pri2:#0369a1;--ok:#16a34a;--bad:#dc2626}
    .card{background:#fff;border-radius:1rem;box-shadow:0 6px 18px rgba(2,6,23,.08)}
    .tab-active{background:linear-gradient(135deg,var(--pri),var(--pri2));color:#fff}
    .btn{border-radius:.9rem;padding:.65rem 1rem;font-weight:600}
    .btn-primary{background:var(--pri);color:#fff}
    .btn-primary:hover{background:var(--pri2)}
    .btn-danger{background:var(--bad);color:#fff}
    .hidden{display:none}
  </style>
</head>
<body class="bg-slate-100 min-h-screen">
  <!-- Header -->
  <header class="card max-w-5xl mx-auto mt-4 px-5 py-4">
    <div class="flex items-center justify-between gap-3">
      <div>
        <h1 class="text-2xl font-bold text-slate-900">A to Z Packers & Movers</h1>
        <p class="text-slate-600">Daily Accounts (Firestore, realtime)</p>
      </div>
      <div class="text-right">
        <p id="todayText" class="text-slate-600"></p>
        <div class="mt-2 flex items-center gap-2 justify-end">
          <span id="whoami" class="text-sm text-slate-600"></span>
          <button id="btnSignOutTop" class="btn btn-danger hidden">Sign out</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Auth -->
  <section id="authCard" class="card max-w-5xl mx-auto mt-4 p-5">
    <h2 class="text-xl font-semibold mb-3">Sign in</h2>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
      <input id="email" type="email" placeholder="you@example.com" class="px-3 py-2 border rounded-xl"/>
      <input id="password" type="password" placeholder="••••••••" class="px-3 py-2 border rounded-xl"/>
      <button id="btnSignIn" class="btn btn-primary">Sign in</button>
    </div>
    <p id="authMsg" class="mt-2 text-sm text-rose-600"></p>
  </section>

  <!-- Error banner -->
  <div id="errBar" class="hidden max-w-5xl mx-auto mt-3 bg-rose-50 text-rose-700 border border-rose-200 rounded-xl px-4 py-2 text-sm">
    <span id="errText"></span>
  </div>

  <!-- App -->
  <section id="app" class="hidden max-w-5xl mx-auto mt-4 card">
    <div class="flex">
      <button class="tab flex-1 py-3 px-4 tab-active" data-tab="expenses"> Expenses</button>
      <button class="tab flex-1 py-3 px-4" data-tab="income"> Income</button>
      <button class="tab flex-1 py-3 px-4" data-tab="totals"> Totals</button>
    </div>

    <!-- Expenses -->
    <div id="expenses" class="p-5">
      <form id="expenseForm" class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-4">
        <input type="date" id="expenseDate" class="px-3 py-2 border rounded-xl"/>
        <select id="expenseCategory" class="px-3 py-2 border rounded-xl">
          <option value="">Category</option>
          <option>Fuel</option><option>Food</option><option>Stationery</option>
          <option>Repair</option><option>Labour</option><option>Misc</option>
        </select>
        <select id="expensePayment" class="px-3 py-2 border rounded-xl">
          <option value="">Mode</option><option>UPI</option><option>Cash</option>
          <option>Bank Transfer</option><option>Card</option>
        </select>
        <input type="number" id="expenseAmount" placeholder="Amount " step="0.01" class="px-3 py-2 border rounded-xl"/>
        <input type="text" id="expenseDescription" placeholder="Description" class="md:col-span-3 px-3 py-2 border rounded-xl"/>
        <button class="md:col-span-4 btn btn-danger">Add Expense</button>
      </form>
      <div id="expensesList" class="space-y-2"></div>
    </div>

    <!-- Income -->
    <div id="income" class="p-5 hidden">
      <form id="incomeForm" class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-4">
        <input type="date" id="incomeDate" class="px-3 py-2 border rounded-xl"/>
        <select id="incomeCategory" class="px-3 py-2 border rounded-xl">
          <option value="">Category</option>
          <option>Packers & Movers</option><option>Courier</option>
          <option>Ticket Booking</option><option>Other</option>
        </select>
        <select id="incomePayment" class="px-3 py-2 border rounded-xl">
          <option value="">Mode</option><option>UPI</option><option>Cash</option>
          <option>Bank Transfer</option><option>Card</option>
        </select>
        <input type="number" id="incomeAmount" placeholder="Amount " step="0.01" class="px-3 py-2 border rounded-xl"/>
        <input type="text" id="incomeDescription" placeholder="Description" class="md:col-span-3 px-3 py-2 border rounded-xl"/>
        <button class="md:col-span-4 btn btn-primary">Add Income</button>
      </form>
      <div id="incomesList" class="space-y-2"></div>
    </div>

    <!-- Totals -->
    <div id="totals" class="p-6 hidden">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
        <div class="bg-slate-50 rounded-xl p-4">
          <p class="text-slate-500 text-sm">Total Expenses</p>
          <p id="totalExpenses" class="text-2xl font-bold text-rose-600">0</p>
        </div>
        <div class="bg-slate-50 rounded-xl p-4">
          <p class="text-slate-500 text-sm">Total Income</p>
          <p id="totalIncome" class="text-2xl font-bold text-emerald-600">0</p>
        </div>
        <div class="bg-slate-50 rounded-xl p-4">
          <p class="text-slate-500 text-sm">Net (Income  Expenses)</p>
          <p id="netBalance" class="text-2xl font-bold text-sky-600">0</p>
        </div>
      </div>
    </div>
  </section>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Your config (as provided earlier)
    const firebaseConfig = {
      apiKey: "AIzaSyCieI_dFRI3K-TDNy0JFe02ndbT2ZO4bag",
      authDomain: "a-to-z-daily-account.firebaseapp.com",
      projectId: "a-to-z-daily-account",
      storageBucket: "a-to-z-daily-account.firebasestorage.app",
      messagingSenderId: "248686153632",
      appId: "1:248686153632:web:4399b9f34b0c97ae46dec5"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // UI refs
    const todayISO = () => new Date().toISOString().split('T')[0];
    const fmtINR = (n) => new Intl.NumberFormat('en-IN', { style:'currency', currency:'INR' }).format(n);

    document.getElementById("todayText").textContent =
      new Date().toLocaleString('en-IN',{weekday:'long', day:'2-digit', month:'long', year:'numeric'});

    const authCard = document.getElementById("authCard");
    const appCard  = document.getElementById("app");
    const whoami   = document.getElementById("whoami");
    const btnSignIn = document.getElementById("btnSignIn");
    const btnSignOutTop = document.getElementById("btnSignOutTop");
    const authMsg = document.getElementById("authMsg");
    const errBar  = document.getElementById("errBar");
    const errText = document.getElementById("errText");

    const expenseForm = document.getElementById("expenseForm");
    const incomeForm  = document.getElementById("incomeForm");
    const expensesList = document.getElementById("expensesList");
    const incomesList  = document.getElementById("incomesList");

    document.getElementById("expenseDate").value = todayISO();
    document.getElementById("incomeDate").value  = todayISO();

    // Tabs
    document.querySelectorAll(".tab").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        document.querySelectorAll(".tab").forEach(b=>b.classList.remove("tab-active"));
        btn.classList.add("tab-active");
        ["expenses","income","totals"].forEach(id=>document.getElementById(id).classList.add("hidden"));
        document.getElementById(btn.dataset.tab).classList.remove("hidden");
      });
    });

    // Error helper
    function showError(e){
      errText.textContent = (e?.message || e || "Unknown error");
      errBar.classList.remove("hidden");
      setTimeout(()=>errBar.classList.add("hidden"), 6000);
      console.error(e);
    }

    // Auth
    btnSignIn.addEventListener("click", async ()=>{
      authMsg.textContent = "";
      try{
        const email = document.getElementById("email").value.trim();
        const pass  = document.getElementById("password").value;
        await signInWithEmailAndPassword(auth, email, pass);
      }catch(e){ authMsg.textContent = e?.message || "Sign-in failed"; }
    });
    btnSignOutTop.addEventListener("click", async ()=>{ try{ await signOut(auth); }catch(e){ showError(e); } });

    onAuthStateChanged(auth, (user)=>{
      if (user){
        whoami.textContent = user.email;
        authCard.classList.add("hidden");
        appCard.classList.remove("hidden");
        btnSignOutTop.classList.remove("hidden");
        startRealtime();
      }else{
        whoami.textContent = "";
        authCard.classList.remove("hidden");
        appCard.classList.add("hidden");
        btnSignOutTop.classList.add("hidden");
      }
    });

    // Submit handlers
    expenseForm.addEventListener("submit", async (e)=>{
      e.preventDefault();
      const item = {
        date: document.getElementById("expenseDate").value || todayISO(),
        category: (document.getElementById("expenseCategory").value||"").trim(),
        payment:  (document.getElementById("expensePayment").value||"").trim(),
        description: (document.getElementById("expenseDescription").value||"").trim(),
        amount: parseFloat(document.getElementById("expenseAmount").value||"0"),
        updatedAt: serverTimestamp(),
        updatedBy: auth.currentUser?.email || auth.currentUser?.uid
      };
      if (!item.category || !item.payment || !item.amount){ showError("Category, Mode and Amount are required."); return; }
      try{
        await addDoc(collection(db,"expenses"), item);
        e.target.reset(); document.getElementById("expenseDate").value = todayISO();
      }catch(err){ showError(err); }
    });

    incomeForm.addEventListener("submit", async (e)=>{
      e.preventDefault();
      const item = {
        date: document.getElementById("incomeDate").value || todayISO(),
        category: (document.getElementById("incomeCategory").value||"").trim(),
        payment:  (document.getElementById("incomePayment").value||"").trim(),
        description: (document.getElementById("incomeDescription").value||"").trim(),
        amount: parseFloat(document.getElementById("incomeAmount").value||"0"),
        updatedAt: serverTimestamp(),
        updatedBy: auth.currentUser?.email || auth.currentUser?.uid
      };
      if (!item.category || !item.payment || !item.amount){ showError("Category, Mode and Amount are required."); return; }
      try{
        await addDoc(collection(db,"income"), item);
        e.target.reset(); document.getElementById("incomeDate").value = todayISO();
      }catch(err){ showError(err); }
    });

    // Live listeners + totals
    function startRealtime(){
      const today = todayISO();
      const expQ = query(collection(db,"expenses"), where("date","==", today));
      const incQ = query(collection(db,"income"),   where("date","==", today));

      onSnapshot(expQ, (qs)=>{
        const items = qs.docs.map(d=>({id:d.id, ...d.data()}));
        renderList(expensesList, items, "expense");
        updateTotals();
      }, showError);

      onSnapshot(incQ, (qs)=>{
        const items = qs.docs.map(d=>({id:d.id, ...d.data()}));
        renderList(incomesList, items, "income");
        updateTotals();
      }, showError);
    }

    function renderList(container, arr, type){
      container.innerHTML = "";
      arr.sort((a,b)=>(a.updatedAt?.seconds||0)-(b.updatedAt?.seconds||0));
      arr.forEach(it=>{
        const row = document.createElement("div");
        row.className = "border rounded-xl px-3 py-2";
        row.innerHTML = `
          <div class="flex justify-between items-center">
            <div class="text-sm">
              <div class="font-semibold">${it.category||"-"}</div>
              <div class="text-slate-500">${new Date(it.date).toLocaleDateString('en-IN')} • ${it.payment||"-"}</div>
              <div class="text-slate-700">${it.description||""}</div>
            </div>
            <div class="text-right ${type==='expense'?'text-rose-600':'text-emerald-600'} font-bold">
              ${new Intl.NumberFormat('en-IN',{style:'currency',currency:'INR'}).format(Number(it.amount||0))}
            </div>
          </div>`;
        container.appendChild(row);
      });
      container.dataset[type+"Total"] = arr.reduce((s,x)=> s + Number(x.amount||0), 0);
    }

    function updateTotals(){
      const totalE = Number(document.getElementById("expensesList").dataset.expenseTotal||0);
      const totalI = Number(document.getElementById("incomesList").dataset.incomeTotal||0);
      document.getElementById("totalExpenses").textContent = new Intl.NumberFormat('en-IN',{style:'currency',currency:'INR'}).format(totalE);
      document.getElementById("totalIncome").textContent   = new Intl.NumberFormat('en-IN',{style:'currency',currency:'INR'}).format(totalI);
      document.getElementById("netBalance").textContent    = new Intl.NumberFormat('en-IN',{style:'currency',currency:'INR'}).format(totalI-totalE);
    }
  </script>
</body>
</html>